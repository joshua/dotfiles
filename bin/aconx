#!/bin/bash
set -uo pipefail

function joinStrings { local IFS="$1"; shift; echo "$*"; }
function printHR { printf "_%.0s" {1..90}; echo; }
function conCount { echo "$1" | egrep "$2" | wc -l; }

INCLUDE="(LISTEN|ESTABLISHED)"
EXCLUDE_PATTERNS=(
  '\[::1\]'
  # '127.0.0.1'
  'jabber-client' # Google Hangouts
  'identitys' # Apple Identity Service
  'Safari.SafeBrowsing'
  "2BUA8C4S2C" # 1Password
)
EXCLUDE="($(joinStrings '|' ${EXCLUDE_PATTERNS[@]}))"

C=$(lsof -i -l -n +c0 | egrep ${INCLUDE} | egrep -v ${EXCLUDE})

echo Excluding: $EXCLUDE
printHR
echo "$C" | awk '{print $1, $2, $8, $9}' | sort -f | column -t | nl -n ln
printHR

TOTALS=""
read -r -d '' TOTALS <<- EOM
  Apple:     $(conCount "$C" "(Apple|com.apple.*)")
  Google:    $(conCount "$C" Google)
  Microsoft: $(conCount "$C" Microsoft)
  Local:     $(conCount "$C" "(127\.0\.0\.1|\[::1\])")
  Total:     $(echo "$C" | wc -l)
EOM
echo "$TOTALS" | column -t
